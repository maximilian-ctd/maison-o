<section class="white-spacer section">
  <!-- Logo Transition - analog zum Welcome-Bereich -->
  {%- if section.settings.transition_logo != blank -%}
    <div class="white-spacer__logo-transition" id="white-spacer-logo-transition">
      <div class="white-spacer__logo-transition-wrapper">
        <img 
          src="{{ section.settings.transition_logo | image_url: width: 1200 }}" 
          alt="Maison Ô" 
          class="white-spacer__logo-transition-image"
          loading="eager"
        >
      </div>
    </div>
  {%- endif -%}
  
  <div class="white-spacer__wrapper">
    {%- if section.settings.flow_id != blank -%}
      <heyflow-wrapper 
        flow-id="{{ section.settings.flow_id }}" 
        dynamic-height 
        scroll-up-on-navigation 
        style-config='{"width":"{{ section.settings.form_width | default: '800px' }}","backgroundColor":"#ffffff","background":"#ffffff","theme":"light"}' 
        class="white-spacer__embed">
      </heyflow-wrapper>
    {%- else -%}
      <div class="white-spacer__placeholder">
        <p>Bitte Flow-ID in den Theme-Einstellungen konfigurieren.</p>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
  .white-spacer {
    padding: var(--spacing-3xl) 0;
    padding-top: calc(var(--spacing-3xl) + 10%);
    background-color: #ffffff;
    min-height: 100vh;
    width: 100%;
    position: sticky;
    top: 0;
    z-index: 3;
    overflow: visible;
    display: flex;
    flex-direction: column;
  }

  /* Logo Transition - analog zum Welcome-Bereich */
  .white-spacer__logo-transition {
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    transform: translateY(-50%);
    z-index: 1;
    text-align: center;
    padding: 0 var(--spacing-lg);
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    margin: 0 auto;
    pointer-events: none;
    opacity: 1;
    align-self: flex-start;
  }

  .white-spacer__logo-transition-wrapper {
    max-width: 800px;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    transition: all 0.3s ease;
    position: relative;
    margin: 0;
    padding: 0;
  }

  .white-spacer__logo-transition-wrapper:hover {
    transform: scale(1.02);
  }

  .white-spacer__logo-transition-image {
    max-width: 100%;
    width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
    margin: 0;
    padding: 0;
    vertical-align: bottom;
    filter: brightness(0) invert(1);
  }

  /* Concierge Widget im weißen Bereich - Farbe #340000 */
  .hero-maison__concierge-icon.in-white-section {
    color: #340000 !important;
    border-color: #340000 !important;
    background: rgba(255, 255, 255, 0.9) !important;
    box-shadow: 0 4px 12px rgba(52, 0, 0, 0.2) !important;
  }

  .hero-maison__concierge-icon.in-white-section::after {
    border-color: #340000 !important;
  }

  .hero-maison__concierge-icon.in-white-section .hero-maison__concierge-icon-image {
    filter: brightness(0) saturate(100%) invert(8%) sepia(100%) saturate(10000%) hue-rotate(0deg) !important;
  }

  .hero-maison__concierge-icon.in-white-section:hover {
    color: #340000 !important;
    border-color: #340000 !important;
    background: rgba(255, 255, 255, 1) !important;
    box-shadow: 0 8px 24px rgba(52, 0, 0, 0.3), 0 0 30px rgba(52, 0, 0, 0.2) !important;
  }

  .white-spacer__wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg);
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
    padding-top: var(--spacing-3xl);
    position: relative;
    z-index: 2;
  }

  .white-spacer__embed {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    background-color: #ffffff !important;
    background: #ffffff !important;
  }

  .white-spacer__placeholder {
    padding: var(--spacing-xl);
    text-align: center;
    color: var(--color-text, #666666);
    font-family: 'Montserrat', sans-serif;
  }

  /* HeyFlow Widget Styling */
  .white-spacer heyflow-wrapper {
    background-color: #ffffff !important;
    background: #ffffff !important;
    display: block;
  }

  .white-spacer heyflow-wrapper * {
    background-color: #ffffff !important;
    background: #ffffff !important;
  }

  .white-spacer heyflow-wrapper iframe {
    background-color: #ffffff !important;
    background: #ffffff !important;
  }

  @media (max-width: 1023px) {
    .white-spacer__logo-transition {
      transform: translateY(-45%);
      padding: 0 var(--spacing-md);
    }
    .white-spacer__logo-transition-wrapper {
      max-width: 550px;
    }
  }

  @media (max-width: 767px) {
    .white-spacer {
      padding: var(--spacing-2xl) 0;
      padding-top: calc(var(--spacing-2xl) + 10%);
      z-index: 3;
    }

    .white-spacer__wrapper {
      padding-top: calc(var(--spacing-2xl) + 10%);
    }

    .white-spacer__logo-transition {
      transform: translateY(-35%);
      left: 0;
      right: 0;
      padding: 0 var(--spacing-lg);
      margin: 0 auto;
      width: 100%;
      position: absolute;
      top: 0;
      text-align: center;
      align-items: flex-start;
    }
    .white-spacer__logo-transition-wrapper {
      max-width: 380px;
      padding: 0;
      margin: 0 auto;
      overflow: visible;
      align-items: flex-start;
    }
    .white-spacer__logo-transition-image {
      display: block;
      margin: 0;
      padding: 0;
      vertical-align: bottom;
    }

    .white-spacer__embed {
      max-width: 100%;
    }
  }

  @media (max-width: 480px) {
    .white-spacer__logo-transition {
      transform: translateY(-35%);
      left: 0;
      right: 0;
      padding: 0 var(--spacing-lg);
      margin: 0 auto;
      width: 100%;
      position: absolute;
      top: 0;
      text-align: center;
      align-items: flex-start;
    }
    .white-spacer__logo-transition-wrapper {
      max-width: 320px;
      padding: 0;
      margin: 0 auto;
      overflow: visible;
      align-items: flex-start;
    }
  }
</style>

<script>
  // Versuche, den HeyFlow-Hintergrund über JavaScript zu ändern
  (function() {
    function setHeyFlowBackground() {
      const heyflowWrapper = document.querySelector('.white-spacer heyflow-wrapper');
      if (heyflowWrapper) {
        setTimeout(function() {
          const iframe = heyflowWrapper.querySelector('iframe');
          if (iframe) {
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              if (iframeDoc) {
                iframeDoc.body.style.backgroundColor = '#ffffff';
                iframeDoc.body.style.background = '#ffffff';
              }
            } catch (e) {
              // console.log('HeyFlow verwendet ein Cross-Origin iframe. Der Hintergrund muss im HeyFlow-Dashboard konfiguriert werden.');
            }
          }
        }, 1000);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setHeyFlowBackground);
    } else {
      setHeyFlowBackground();
    }
    
    const observer = new MutationObserver(function(mutations) {
      setHeyFlowBackground();
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  })();

  // Concierge Widget Farbe im weißen Bereich ändern
  (function() {
    const conciergeButton = document.querySelector('[data-concierge-chat]');
    const whiteSpacer = document.querySelector('.white-spacer');
    
    if (!conciergeButton || !whiteSpacer) return;
    
    function checkWidgetPosition() {
      const whiteSpacerRect = whiteSpacer.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      
      // Prüfe ob weißer Bereich im Viewport sichtbar ist
      // Wenn der obere Rand des weißen Bereichs im oberen Teil des Viewports ist
      const isWhiteSectionVisible = whiteSpacerRect.top < viewportHeight && whiteSpacerRect.bottom > 0;
      
      if (isWhiteSectionVisible) {
        conciergeButton.classList.add('in-white-section');
      } else {
        conciergeButton.classList.remove('in-white-section');
      }
    }
    
    // Initial check
    checkWidgetPosition();
    
    // Bei Scroll prüfen
    window.addEventListener('scroll', checkWidgetPosition, { passive: true });
    window.addEventListener('resize', checkWidgetPosition);
    
    // Intersection Observer für präzisere Erkennung
    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          conciergeButton.classList.add('in-white-section');
        } else {
          // Nur entfernen wenn der weiße Bereich komplett aus dem Viewport ist
          if (entry.boundingClientRect.bottom < 0) {
            conciergeButton.classList.remove('in-white-section');
          }
        }
      });
    }, {
      threshold: [0, 0.1, 0.5, 1],
      rootMargin: '0px'
    });
    
    observer.observe(whiteSpacer);
  })();
</script>

{% schema %}
{
  "name": "White Spacer mit HeyFlow",
  "settings": [
    {
      "type": "image_picker",
      "id": "transition_logo",
      "label": "Übergangs-Logo",
      "info": "Logo, das zwischen dem roten und weißen Bereich angezeigt wird (3.png)"
    },
    {
      "type": "text",
      "id": "flow_id",
      "label": "HeyFlow Flow ID",
      "default": "OXukvFlXlOj4Om7gpATS",
      "info": "Die Flow-ID aus Ihrem HeyFlow-Account"
    },
    {
      "type": "text",
      "id": "form_width",
      "label": "Formular Breite",
      "default": "800px",
      "info": "Breite des Formulars (z.B. 800px, 100%)"
    }
  ],
  "presets": [
    {
      "name": "White Spacer mit HeyFlow"
    }
  ]
}
{% endschema %}

